<?php

/**
 * @file
 * Primary module hooks for FlowDrop Node Session module.
 *
 * This module provides entity context support for FlowDrop playground sessions,
 * allowing workflows to be initialized with a Drupal entity (node, term, etc.)
 * as context data.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\flowdrop_playground\Entity\FlowDropPlaygroundMessageInterface;

/**
 * Implements hook_theme().
 *
 * Registers custom theme implementations for the entity context playground.
 * These provide fullscreen HTML and minimal page templates to remove Drupal's
 * default page chrome (toolbar, admin menu, etc.) for an immersive experience.
 */
function echack_flowdrop_node_session_theme(): array {
  return [
    "html__echack_flowdrop_entity_playground_fullscreen" => [
      "render element" => "elements",
      "base hook" => "html",
      "template" => "html--echack-flowdrop-entity-playground-fullscreen",
    ],
    "page__echack_flowdrop_entity_playground" => [
      "render element" => "elements",
      "base hook" => "page",
      "template" => "page--echack-flowdrop-entity-playground",
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_html_alter().
 *
 * Suggests a fullscreen HTML template for the entity context playground route.
 * This removes Drupal's default page chrome (toolbar, admin menu, etc.)
 * to provide an immersive fullscreen experience.
 */
function echack_flowdrop_node_session_theme_suggestions_html_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === "echack_flowdrop_node_session.playground.entity") {
    $suggestions[] = "html__echack_flowdrop_entity_playground_fullscreen";
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Suggests a minimal page template for the entity context playground route.
 * This renders only the content without local actions, breadcrumbs, etc.
 */
function echack_flowdrop_node_session_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === "echack_flowdrop_node_session.playground.entity") {
    $suggestions[] = "page__echack_flowdrop_entity_playground";
  }
}

/**
 * Implements hook_entity_operation().
 *
 * Adds a "Validate" operation to nodes in the content list that links
 * to the FlowDrop entity playground with entity context.
 */
function echack_flowdrop_node_session_entity_operation(EntityInterface $entity): array {
  $operations = [];

  // Only add validate operation for nodes.
  if ($entity->getEntityTypeId() !== 'node') {
    return $operations;
  }

  // Check if user has permission to create playground sessions.
  if (!\Drupal::currentUser()->hasPermission('create flowdrop_playground_session')) {
    return $operations;
  }

  // Default workflow for validation (can be made configurable).
  $workflow_id = 'test_node_input';

  // Build the URL to the entity playground.
  $url = \Drupal\Core\Url::fromRoute('echack_flowdrop_node_session.playground.entity', [
    'workflow_id' => $workflow_id,
  ], [
    'query' => [
      'entity_type' => 'node',
      'entity_id' => $entity->id(),
    ],
  ]);

  $operations['validate'] = [
    'title' => t('Validate'),
    'url' => $url,
    'weight' => 50,
  ];

  return $operations;
}

/**
 * Implements hook_entity_presave().
 *
 * Injects entity context data into playground messages for sessions that have
 * entity context configured. This allows EntityContext nodes in workflows to
 * receive the pre-loaded entity data via initialData.
 */
function echack_flowdrop_node_session_entity_presave(EntityInterface $entity): void {
  // Only process playground message entities.
  if (!$entity instanceof FlowDropPlaygroundMessageInterface) {
    return;
  }

  // Get the injector service and inject entity context.
  /** @var \Drupal\echack_flowdrop_node_session\EventSubscriber\EntityContextInjectorSubscriber $injector */
  $injector = \Drupal::service("echack_flowdrop_node_session.entity_context_injector");
  $injector->injectEntityContext($entity);
}
